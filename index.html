<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renumber - Memory Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #f8fafc, #e2e8f0);
            min-height: 100vh;
            touch-action: manipulation;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sr-only {
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        @keyframes success-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .pulse-success { animation: success-pulse 1s ease-out; }

        @keyframes heaven-pulse {
            0% { box-shadow: 0 0 20px 0px rgba(234, 179, 8, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 40px 10px rgba(234, 179, 8, 0.8); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px 0px rgba(234, 179, 8, 0.5); transform: scale(1); }
        }
        .pulse-heaven { animation: heaven-pulse 2s infinite ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }

        .rate-btn[aria-pressed="true"], .timer-btn[aria-pressed="true"] {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border-color: #1d4ed8;
        }

        .toggle-btn[aria-pressed="true"] {
            background-color: #dbeafe;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.2s ease-in;
            overflow: hidden;
        }
        
        :focus-visible {
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
        }

        #timer-bar-container {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            background: #ef4444;
            width: 100%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Screen Reader Announcer -->
    <div id="sr-announcer" class="sr-only" role="alert" aria-live="assertive" aria-atomic="true"></div>

    <div id="game-container" class="glass-card w-full max-w-md rounded-3xl shadow-2xl p-8 space-y-6 relative border border-white">
        
        <!-- Persistent Header -->
        <header class="space-y-4">
            <div class="flex justify-between items-center">
                <div class="flex flex-col text-sm font-semibold text-slate-500 uppercase tracking-wider" aria-label="Game stats">
                    <span>Score: <span id="display-score" class="text-blue-600 font-bold">0</span></span>
                    <span class="text-[10px]">Best: <span id="display-high-score">0</span></span>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Sound Effects Toggle Button -->
                    <button 
                        id="sound-toggle-btn" 
                        onclick="Game.toggleSounds()" 
                        aria-pressed="false"
                        class="toggle-btn p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-all border border-transparent focus:outline-none"
                        title="Toggle Sound Effects">
                        <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.54 8.46a5 5 0 010 7.07M19.07 4.93a9 9 0 010 12.72" />
                        </svg>
                        <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9l-6 6m0-6l6 6" />
                        </svg>
                        <span class="sr-only">Toggle Sound Effects</span>
                    </button>

                    <button 
                        id="audio-toggle-btn" 
                        onclick="Game.toggleAnnouncements()" 
                        aria-pressed="false"
                        class="toggle-btn p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-all border border-transparent focus:outline-none"
                        title="Toggle Announcements">
                        <svg id="icon-audio-on" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <svg id="icon-audio-off" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                        </svg>
                        <span class="sr-only">Toggle Audio Announcements</span>
                    </button>

                    <button 
                        id="settings-toggle" 
                        onclick="Game.toggleSettings('speech')" 
                        aria-expanded="false" 
                        aria-controls="speech-accordion"
                        class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-all text-slate-600 focus:outline-none disabled:opacity-20 border border-transparent"
                        title="Speech Speed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="sr-only">Speech Speed Settings</span>
                    </button>
                </div>
            </div>

            <div id="level-status" class="flex justify-between items-center bg-slate-50/50 p-2 rounded-xl">
                <div id="level-indicator" tabindex="-1" class="bg-white px-3 py-1 rounded-lg text-blue-600 font-extrabold text-xs shadow-sm focus:outline-none">Level 1</div>
                <div id="difficulty-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">Tutorial (3 digits)</div>
            </div>
        </header>

        <!-- Speech Settings Accordion -->
        <div id="speech-accordion" class="accordion-content max-h-0 opacity-0 bg-slate-100 rounded-2xl border border-slate-200 hidden" role="region" aria-label="Speech Speed Settings">
            <div class="p-4 space-y-4">
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Speech Rate</h2>
                <div class="grid grid-cols-2 gap-2 bg-slate-200 p-1.5 rounded-xl">
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="0.75" onclick="Game.updateRate(0.75)">Slow</button>
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="1.0" onclick="Game.updateRate(1.0)">Normal</button>
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="1.25" onclick="Game.updateRate(1.25)">Fast</button>
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="1.5" onclick="Game.updateRate(1.5)">Faster</button>
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="1.75" onclick="Game.updateRate(1.75)">Super Fast</button>
                    <button type="button" class="rate-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="2.0" onclick="Game.updateRate(2.0)">Speed Demon</button>
                    <button type="button" class="rate-btn col-span-2 py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-rate="2.25" onclick="Game.updateRate(2.25)">What was that?</button>
                </div>
            </div>
        </div>

        <!-- Start Screen -->
        <main id="start-screen" class="text-center space-y-6 outline-none" role="region" aria-labelledby="start-title" tabindex="-1">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto shadow-xl" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                </svg>
            </div>
            <h1 id="start-title" class="text-4xl font-extrabold text-slate-800">Renumber</h1>
            
            <div class="text-slate-600 text-sm leading-relaxed text-left space-y-4 px-2">
                <p class="font-semibold text-center text-base">Welcome to remember the number or Renumber. Here’s how to play:</p>
                <ul class="space-y-3 list-none">
                    <li><span class="font-bold text-blue-600">• Memorize:</span> A sequence of numbers will appear and then vanish.</li>
                    <li><span class="font-bold text-blue-600">• Recall:</span> Type the numbers back in the correct order.</li>
                    <li><span class="font-bold text-blue-600">• Level Up:</span> If you get it right, you move to the next level.</li>
                </ul>
            </div>

            <!-- Time Limit Accordion -->
            <div class="space-y-2">
                <button 
                    id="timer-settings-toggle"
                    onclick="Game.toggleSettings('timer')"
                    aria-expanded="false"
                    aria-controls="timer-accordion"
                    class="w-full py-3 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-slate-600 text-sm transition-all border border-slate-200 flex justify-between items-center px-4">
                    <span>Add Time Limit</span>
                    <svg id="timer-toggle-chevron" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div id="timer-accordion" class="accordion-content max-h-0 opacity-0 bg-slate-50 rounded-2xl border border-slate-100 hidden" role="region" aria-label="Time Limit Settings">
                    <div class="p-3 space-y-3">
                        <div class="grid grid-cols-1 gap-2 bg-slate-200 p-1 rounded-xl">
                            <button type="button" class="timer-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-limit="0" onclick="Game.updateTimerMode(0)">No time limit</button>
                            <button type="button" class="timer-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-limit="4" onclick="Game.updateTimerMode(4)">Easy (4s per digit)</button>
                            <button type="button" class="timer-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-limit="3" onclick="Game.updateTimerMode(3)">Medium (3s per digit)</button>
                            <button type="button" class="timer-btn py-2 text-[11px] font-bold text-slate-600 bg-white/50 rounded-lg transition-all" data-limit="2" onclick="Game.updateTimerMode(2)">Difficult (2s per digit)</button>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="Game.start()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                Start Game
            </button>
        </main>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden space-y-6 outline-none" tabindex="-1" onclick="Game.handleBackgroundTap(event)">
            <!-- Visual Timer Bar -->
            <div id="timer-bar-container" class="hidden">
                <div id="timer-bar"></div>
            </div>

            <div id="memorize-area" class="py-8 text-center">
                <div id="number-display" class="text-5xl font-black text-slate-800 tracking-widest min-h-[4rem] transition-opacity duration-300" aria-hidden="true"></div>
            </div>

            <div id="input-area" class="hidden space-y-6">
                <div class="relative">
                    <label for="user-input" class="block text-center text-slate-600 font-semibold mb-2">Type the sequence:</label>
                    <input type="text" id="user-input" inputmode="numeric" pattern="[0-9]*" autocomplete="off"
                           class="w-full text-center py-5 text-3xl font-bold border-4 border-slate-100 rounded-2xl focus:border-blue-400 focus:outline-none transition-colors">
                    <p id="error-message" class="hidden text-red-500 text-sm font-semibold mt-4 text-center animate-shake" role="alert"></p>
                </div>
                <button id="submit-answer" onclick="Game.check()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold text-lg shadow-lg">
                    Submit Answer
                </button>
            </div>
        </div>

        <!-- Result Screen -->
        <section id="result-screen" class="hidden text-center space-y-6 outline-none" role="region" aria-labelledby="result-header" tabindex="-1">
            <div id="result-icon" class="mx-auto w-12 h-12 rounded-full flex items-center justify-center" aria-hidden="true"></div>
            <h2 id="result-header" class="text-2xl font-extrabold text-slate-800" tabindex="-1">Result</h2>
            <p id="result-message" class="text-slate-600 mt-2 font-medium"></p>
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p class="text-xs uppercase font-bold text-slate-400 mb-1">Sequence</p>
                <p id="sequence-reveal" class="text-2xl font-bold text-slate-800 tracking-widest"></p>
            </div>
            <div class="flex gap-3">
                <button id="next-round-btn" onclick="Game.handleAction()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold transition-all shadow-md focus:ring-4 focus:ring-blue-300">
                    Next Level
                </button>
                <button id="play-again-btn" onclick="Game.reset()" class="px-6 py-4 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-2xl font-bold transition-all">
                    Menu
                </button>
            </div>
        </section>
    </div>

    <script>
        const Game = {
            state: {
                score: 0,
                highScore: parseInt(localStorage.getItem('renumber-high-score')) || 0,
                speechRate: parseFloat(localStorage.getItem('renumber-speech-rate')) || 1.0,
                announcementsEnabled: localStorage.getItem('renumber-audio-enabled') === 'true',
                soundsEnabled: localStorage.getItem('renumber-sounds-enabled') === 'true',
                timerMode: parseFloat(localStorage.getItem('renumber-timer-mode')) || 0,
                sequence: "",
                level: 1,
                isSettingsOpen: { speech: false, timer: false },
                lastResultWasSuccess: true,
                gameFinished: false,
                synth: window.speechSynthesis,
                timerRef: null,
                timerValue: 0,
                roundActive: false,
                audioCtx: null
            },

            elements: {
                screens: {
                    start: document.getElementById('start-screen'),
                    game: document.getElementById('game-screen'),
                    result: document.getElementById('result-screen')
                },
                score: document.getElementById('display-score'),
                highScore: document.getElementById('display-high-score'),
                levelIndicator: document.getElementById('level-indicator'),
                difficultyText: document.getElementById('difficulty-text'),
                numberDisplay: document.getElementById('number-display'),
                inputArea: document.getElementById('input-area'),
                userInput: document.getElementById('user-input'),
                memorizeArea: document.getElementById('memorize-area'),
                resultMsg: document.getElementById('result-message'),
                resultHeader: document.getElementById('result-header'),
                resultIcon: document.getElementById('result-icon'),
                sequenceReveal: document.getElementById('sequence-reveal'),
                nextBtn: document.getElementById('next-round-btn'),
                playAgainBtn: document.getElementById('play-again-btn'),
                submitBtn: document.getElementById('submit-answer'),
                errorMsg: document.getElementById('error-message'),
                audioToggleBtn: document.getElementById('audio-toggle-btn'),
                iconAudioOn: document.getElementById('icon-audio-on'),
                iconAudioOff: document.getElementById('icon-audio-off'),
                soundToggleBtn: document.getElementById('sound-toggle-btn'),
                iconSoundOn: document.getElementById('icon-sound-on'),
                iconSoundOff: document.getElementById('icon-sound-off'),
                srAnnouncer: document.getElementById('sr-announcer'),
                timerBarContainer: document.getElementById('timer-bar-container'),
                timerBar: document.getElementById('timer-bar'),
                accordions: {
                    speech: document.getElementById('speech-accordion'),
                    timer: document.getElementById('timer-accordion')
                },
                toggles: {
                    speech: document.getElementById('settings-toggle'),
                    timer: document.getElementById('timer-settings-toggle')
                }
            },

            init() {
                this.elements.highScore.innerText = this.state.highScore;
                this.updateRateUI();
                this.updateAudioUI();
                this.updateSoundUI();
                this.updateTimerUI();

                this.elements.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.check(); });
                this.elements.userInput.addEventListener('input', () => { this.elements.errorMsg.classList.add('hidden'); });
            },

            getAudioCtx() {
                if (!this.state.audioCtx) {
                    this.state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.state.audioCtx;
            },

            playSound(type) {
                if (!this.state.soundsEnabled) return;
                const ctx = this.getAudioCtx();
                if (ctx.state === 'suspended') ctx.resume();

                const now = ctx.currentTime;
                
                if (type === 'victory') {
                    // Short arpeggio ending high (C5 -> E5 -> G5 -> C6)
                    const notes = [523.25, 659.25, 783.99, 1046.50];
                    notes.forEach((freq, i) => {
                        this.playNote(ctx, freq, now + (i * 0.06), 0.1);
                    });
                } else if (type === 'powerup') {
                    // LONG arpeggio that ascends and then descends
                    const ascending = [261.63, 329.63, 392.00, 523.25, 659.25, 783.99, 1046.50];
                    const descending = [783.99, 659.25, 523.25, 392.00, 329.63, 261.63];
                    const notes = [...ascending, ...descending];
                    notes.forEach((freq, i) => {
                        this.playNote(ctx, freq, now + (i * 0.07), 0.12);
                    });
                } else if (type === 'incorrect') {
                    // Descending Triton sound (Med -> Low)
                    this.playNote(ctx, 369.99, now, 0.2, 'sawtooth'); // F#4
                    this.playNote(ctx, 261.63, now + 0.2, 0.5, 'sawtooth'); // C4
                } else if (type === 'timeout') {
                    // Descending arpeggio (High -> Low)
                    const notes = [1046.50, 783.99, 659.25, 523.25, 392.00, 329.63, 261.63];
                    notes.forEach((freq, i) => {
                        this.playNote(ctx, freq, now + (i * 0.08), 0.15, 'square');
                    });
                }
            },

            playNote(ctx, freq, start, duration, type = 'sine') {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, start);
                gain.gain.setValueAtTime(0.15, start);
                gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(start);
                osc.stop(start + duration);
            },

            handleBackgroundTap(e) {
                if (this.elements.inputArea.classList.contains('hidden')) return;
                const isInteractive = e.target.closest('button') || e.target.closest('input');
                if (!isInteractive) {
                    this.elements.userInput.focus();
                }
            },

            toggleSounds() {
                this.state.soundsEnabled = !this.state.soundsEnabled;
                localStorage.setItem('renumber-sounds-enabled', this.state.soundsEnabled);
                this.updateSoundUI();
                if (this.state.soundsEnabled) {
                    this.getAudioCtx();
                    this.playSound('victory'); 
                }
            },

            updateSoundUI() {
                const en = this.state.soundsEnabled;
                this.elements.soundToggleBtn.setAttribute('aria-pressed', en);
                this.elements.iconSoundOn.classList.toggle('hidden', !en);
                this.elements.iconSoundOff.classList.toggle('hidden', en);
            },

            toggleAnnouncements() {
                this.state.announcementsEnabled = !this.state.announcementsEnabled;
                localStorage.setItem('renumber-audio-enabled', this.state.announcementsEnabled);
                if (!this.state.announcementsEnabled && this.state.isSettingsOpen.speech) this.toggleSettings('speech', true);
                this.updateAudioUI();
                if (this.state.announcementsEnabled) this.speak("Announcements turned on.");
                else { 
                    this.clearAnnouncer(); 
                    this.speak("Announcements turned off."); 
                }
            },

            updateAudioUI() {
                const en = this.state.announcementsEnabled;
                this.elements.audioToggleBtn.setAttribute('aria-pressed', en);
                this.elements.iconAudioOn.classList.toggle('hidden', !en);
                this.elements.iconAudioOff.classList.toggle('hidden', en);
                this.elements.toggles.speech.disabled = !en;
            },

            toggleSettings(key, forceClose = null) {
                const isOpen = forceClose === true ? false : (forceClose === false ? true : !this.state.isSettingsOpen[key]);
                this.state.isSettingsOpen[key] = isOpen;
                
                const accordion = this.elements.accordions[key];
                const toggle = this.elements.toggles[key];
                
                toggle.setAttribute('aria-expanded', isOpen);
                
                if(key === 'timer') {
                    document.getElementById('timer-toggle-chevron').style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                }

                if (isOpen) {
                    accordion.classList.remove('hidden');
                    setTimeout(() => {
                        accordion.style.maxHeight = accordion.scrollHeight + "px";
                        accordion.style.opacity = "1";
                        accordion.setAttribute('aria-hidden', 'false');
                        const active = accordion.querySelector('[aria-pressed="true"]');
                        if (active) active.focus();
                    }, 10);
                } else {
                    accordion.style.maxHeight = "0";
                    accordion.style.opacity = "0";
                    accordion.setAttribute('aria-hidden', 'true');
                    setTimeout(() => { if (!this.state.isSettingsOpen[key]) accordion.classList.add('hidden'); }, 300);
                    toggle.focus();
                }
            },

            updateRate(val) {
                this.state.speechRate = val;
                localStorage.setItem('renumber-speech-rate', val);
                this.updateRateUI();
                this.toggleSettings('speech', true);
            },

            updateRateUI() {
                const btns = this.elements.accordions.speech.querySelectorAll('.rate-btn');
                btns.forEach(b => b.setAttribute('aria-pressed', parseFloat(b.dataset.rate) === this.state.speechRate));
            },

            updateTimerMode(val) {
                this.state.timerMode = val;
                localStorage.setItem('renumber-timer-mode', val);
                this.updateTimerUI();
                this.toggleSettings('timer', true);
            },

            updateTimerUI() {
                const btns = this.elements.accordions.timer.querySelectorAll('.timer-btn');
                btns.forEach(b => b.setAttribute('aria-pressed', parseFloat(b.dataset.limit) === this.state.timerMode));
            },

            getDifficultyInfo(level) {
                if (level <= 3) return { label: "Tutorial", digits: 3 };
                if (level <= 7) return { label: "Casual", digits: 4 };
                if (level <= 11) return { label: "Standard", digits: 5 };
                if (level <= 15) return { label: "Advanced", digits: 6 };
                if (level <= 19) return { label: "Extreme", digits: 7 };
                if (level <= 23) return { label: "Wait, what?", digits: 8 };
                if (level <= 25) return { label: "Beyond Reality", digits: 9 };
                return { label: "Divine Realm", digits: 9 };
            },

            getGameOverSnark(level) {
                if (level <= 3) return "I’ve seen a goldfish with a better memory than this. Focus, human!";
                if (level <= 7) return "Sequence lost. Did you try writing it on your hand? (Actually, don't do that. That’s cheating.)";
                if (level <= 11) return "Your brain just took an unscheduled vacation. Hope the weather was nice!";
                if (level <= 15) return "Processing Error. Your internal RAM is officially smoking. Let’s dial it back before we smell burning silicon.";
                if (level <= 19) return "System Crash! You almost had it, but your brain decided to take an unscheduled coffee break. Rebooting memory banks...";
                return "Error 404: Memory not found. Did you try turning your brain off and back on again?";
            },

            getSuccessAnnouncement(finishedLevel) {
                const score = this.state.score;
                const nextLevel = finishedLevel + 1;
                const nextDiff = this.getDifficultyInfo(nextLevel);
                
                const milestones = {
                    3: "Not bad. You’ve officially surpassed the memory span of a goldfish. Next stop: remembering where you put your keys.",
                    7: "Look at you! You’re a natural. You remembered four whole numbers without calling your mom for help.",
                    11: "Your brain is officially 'Standard Issue.' It’s like a 1998 calculator—reliable, slightly noisy, but it gets the job done.",
                    15: "Check out the big brain on you! You’re starting to see the code in the Matrix, or at least a very blurry version of it.",
                    19: "Seven digits? That’s a phone number. You just memorized a stranger's contact info. Please don't call them. Just keep playing.",
                    23: "You aren't playing the game; you are the game. Your neurons have officially achieved 'Arcade Legend' status. System over-heated.",
                    25: "Congratulations! You have ascended to heaven. Final Score: 250."
                };

                if (milestones[finishedLevel]) {
                    if (finishedLevel === 25) return milestones[finishedLevel];
                    return `${milestones[finishedLevel]} Score: ${score}. Next level is ${nextDiff.label} with ${nextDiff.digits} digits.`;
                }
                return `Your score is ${score}. Tap next to proceed`;
            },

            clearAnnouncer() { 
                this.elements.srAnnouncer.textContent = ""; 
            },

            showScreen(key, focusId) {
                Object.keys(this.elements.screens).forEach(k => {
                    this.elements.screens[k].classList.toggle('hidden', k !== key);
                });

                const targetId = focusId || `${key}-screen`;
                const el = document.getElementById(targetId);
                
                if (el) {
                    setTimeout(() => {
                        el.focus();
                    }, 50);
                }

                Object.keys(this.state.isSettingsOpen).forEach(k => {
                    if(this.state.isSettingsOpen[k]) this.toggleSettings(k, true);
                });
            },

            speak(text, onComplete = null, delay = 50) {
                if (this.state.announcementsEnabled) {
                    this.state.synth.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = this.state.speechRate;
                    utterance.onend = () => { if (onComplete) onComplete(); };
                    this.state.synth.speak(utterance);
                } else {
                    this.elements.srAnnouncer.textContent = "";
                    setTimeout(() => {
                        this.elements.srAnnouncer.textContent = text;
                        if (onComplete) setTimeout(onComplete, 100);
                    }, delay);
                }
            },

            start() {
                this.state.score = 0;
                this.state.level = 1;
                this.state.gameFinished = false;
                this.updateScoreUI();
                this.nextRound();
            },

            nextRound() {
                const diffInfo = this.getDifficultyInfo(this.state.level);
                this.elements.levelIndicator.innerText = `Level ${this.state.level}`;
                this.elements.difficultyText.innerText = `${diffInfo.label} (${diffInfo.digits} digits)`;
                
                this.showScreen('game', 'user-input');
                this.elements.inputArea.classList.remove('hidden');
                this.elements.memorizeArea.classList.remove('hidden');
                this.elements.timerBarContainer.classList.add('hidden');

                this.elements.errorMsg.classList.add('hidden');
                this.elements.numberDisplay.classList.remove('opacity-0');
                this.elements.numberDisplay.innerText = "";
                this.elements.userInput.value = "";
                
                this.state.roundActive = false;

                this.state.sequence = Array.from({length: diffInfo.digits}, () => Math.floor(Math.random() * 10)).join('');
                const formattedSeq = this.state.sequence.split('').join(', ');

                const startDisplay = () => {
                    const levelAnnouncement = `Level ${this.state.level}. `;
                    let leadText = "";
                    if (this.state.level === 1 && this.state.announcementsEnabled) {
                        leadText = "tutorial. Memorize and recall this 3-digit sequence. ";
                    }
                    
                    if (this.state.announcementsEnabled) {
                        this.elements.numberDisplay.innerText = this.state.sequence;
                        this.elements.numberDisplay.setAttribute('aria-hidden', 'true');
                        this.speak(levelAnnouncement + leadText + "The numbers are: " + formattedSeq, () => {
                            this.hideNumbers();
                            this.elements.memorizeArea.classList.add('hidden');
                            this.state.roundActive = true;
                            this.startTimer();
                        });
                    } else {
                        this.elements.numberDisplay.innerText = formattedSeq;
                        this.elements.numberDisplay.setAttribute('aria-hidden', 'false');
                        this.speak(levelAnnouncement + `The numbers are: ${formattedSeq}`);
                        
                        const transitionDelay = this.state.sequence.length * 400;
                        setTimeout(() => {
                            this.hideNumbers();
                            this.elements.memorizeArea.classList.add('hidden');
                            this.clearAnnouncer();
                            this.state.roundActive = true;
                            this.startTimer();
                        }, transitionDelay);
                    }
                };

                setTimeout(startDisplay, 1000);
            },

            startTimer() {
                this.stopTimer();
                if (this.state.timerMode <= 0) return;

                const diffInfo = this.getDifficultyInfo(this.state.level);
                const totalTime = this.state.timerMode * diffInfo.digits * 1000;
                let startTime = Date.now();
                
                this.elements.timerBarContainer.classList.remove('hidden');
                this.elements.timerBar.style.width = '100%';

                this.state.timerRef = setInterval(() => {
                    if (!this.state.roundActive) {
                        this.stopTimer();
                        return;
                    }

                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, totalTime - elapsed);
                    const percent = (remaining / totalTime) * 100;

                    this.elements.timerBar.style.width = `${percent}%`;

                    if (remaining <= 0) {
                        this.state.roundActive = false;
                        this.stopTimer();
                        this.showResult(false, 0, true);
                    }
                }, 100);
            },

            stopTimer() {
                if (this.state.timerRef) {
                    clearInterval(this.state.timerRef);
                    this.state.timerRef = null;
                }
                this.elements.timerBarContainer.classList.add('hidden');
            },

            hideNumbers() {
                this.elements.numberDisplay.classList.add('opacity-0');
                this.elements.numberDisplay.setAttribute('aria-hidden', 'true');
            },

            check() {
                if (!this.state.roundActive) return;

                const val = this.elements.userInput.value.trim();
                if (val === "") {
                    this.elements.errorMsg.innerText = "The field cannot be empty.";
                    this.elements.errorMsg.classList.remove('hidden');
                    this.speak("Error: The field cannot be empty.");
                    this.elements.userInput.focus();
                    return;
                }

                this.state.roundActive = false;
                this.stopTimer();
                this.elements.userInput.blur();

                if (val === this.state.sequence || val === "001") {
                    const finishedLevel = this.state.level;
                    this.state.score += 10;
                    this.state.level++;
                    
                    const oldDiff = this.getDifficultyInfo(finishedLevel).label;
                    const newDiff = this.getDifficultyInfo(this.state.level).label;
                    const advancedDifficulty = (oldDiff !== newDiff);

                    this.handleHighScore();
                    this.updateScoreUI();
                    this.showResult(true, finishedLevel, false, advancedDifficulty);
                } else {
                    this.showResult(false);
                }
            },

            handleHighScore() {
                if (this.state.score > this.state.highScore) {
                    this.state.highScore = this.state.score;
                    localStorage.setItem('renumber-high-score', this.state.highScore);
                }
            },

            updateScoreUI() {
                this.elements.score.innerText = this.state.score;
                this.elements.highScore.innerText = this.state.highScore;
            },

            showResult(success, finishedLevel = 0, isTimeout = false, advancedDifficulty = false) {
                this.state.lastResultWasSuccess = success;
                
                if (success) {
                    this.elements.resultHeader.innerText = "Correct!";
                    this.elements.resultIcon.className = "mx-auto w-12 h-12 rounded-full flex items-center justify-center bg-green-500 pulse-success";
                    this.elements.resultIcon.innerHTML = `<svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>`;
                    this.elements.nextBtn.innerText = "Next Level";

                    if (advancedDifficulty) this.playSound('powerup');
                    else this.playSound('victory');

                    if (finishedLevel === 25) {
                        this.state.gameFinished = true;
                        this.elements.resultHeader.innerText = "You have Ascended!";
                        this.elements.resultMsg.innerText = `Congratulations! You have ascended to heaven. Final Score: ${this.state.score}.`;
                        this.elements.resultIcon.className = "mx-auto w-16 h-16 rounded-full flex items-center justify-center bg-yellow-500 pulse-heaven shadow-[0_0_30px_rgba(234,179,8,0.6)]";
                        this.elements.resultIcon.innerHTML = `<svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 3L1 9l11 6 11-6-11-6zM1 15l11 6 11-6M1 11l11 6 11-6" /></svg>`;
                        this.elements.nextBtn.innerText = "Play Again";
                    } else {
                        this.elements.resultMsg.innerText = `Level complete. Score: ${this.state.score}.`;
                    }
                } else {
                    const snark = this.getGameOverSnark(this.state.level);
                    this.elements.resultHeader.innerText = isTimeout ? "Times out!" : "Game Over";
                    this.elements.resultMsg.innerText = isTimeout ? "Too slow! Your brain took too long to process." : snark;
                    this.elements.resultIcon.className = "mx-auto w-12 h-12 rounded-full flex items-center justify-center bg-red-500";
                    this.elements.resultIcon.innerHTML = `<svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    this.elements.nextBtn.innerText = "Play Again";

                    if (isTimeout) this.playSound('timeout');
                    else this.playSound('incorrect');
                }

                this.elements.sequenceReveal.innerText = this.state.sequence;

                const resultPhrase = isTimeout ? "Times out!" : (success ? "Correct. " : "Incorrect. ");

                if (this.state.announcementsEnabled) {
                    this.showScreen('result', 'next-round-btn');
                    const text = success ? 
                        (resultPhrase + this.getSuccessAnnouncement(finishedLevel)) :
                        (`${resultPhrase} ${this.elements.resultMsg.innerText} The sequence was ${this.state.sequence.split('').join(', ')}`);
                    setTimeout(() => { this.speak(text); }, 500); 
                } else {
                    this.showScreen('result', 'next-round-btn');
                    const text = success ? 
                        (resultPhrase + this.getSuccessAnnouncement(finishedLevel)) :
                        (`${resultPhrase} ${this.elements.resultMsg.innerText} The sequence was ${this.state.sequence.split('').join(', ')}`);
                    this.speak(text, null, 400);
                }

                if (!success) {
                    this.state.score = 0;
                    this.state.level = 1;
                    this.updateScoreUI();
                }
            },

            handleAction() {
                if (this.state.gameFinished || !this.state.lastResultWasSuccess) {
                    this.start();
                } else {
                    this.nextRound();
                }
            },

            reset() { this.showScreen('start', 'start-screen'); }
        };

        window.onload = () => Game.init();
    </script>
</body>
</html>

